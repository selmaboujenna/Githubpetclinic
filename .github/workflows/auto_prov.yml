on:
  push:
    branches:
      pets  
name: automate provisioning

jobs:
  build:
    runs-on: self-hosted
    steps:
    # - name: az login
    #   uses: azure/login@v1
    #   with:
    #     auth-type: IDENTITY
    #     client-id: ${{secrets.CLIENT_ID}}
    #     tenant-id: ${{secrets.TENANT_ID}}
    #     subscription-id: ${{secrets.SUBSCRIPTION_ID}}

    - name: initialize terraform
      run: terraform init
      working-directory: /home/adminuser/temp/terraform
    # - name: where am i
    #   run: terraform destroy --auto-approve
    #   working-directory: /home/adminuser/temp/terraform
    - name: create VMs
      run: terraform apply --auto-approve
      working-directory: /home/adminuser/temp/terraform
  
  configure:
    needs: build
    runs-on: self-hosted
    steps:
    - name: maak een vault password file
      run: echo "${{secrets.VAULT_PASS}}" > /tmp/vault_pass.txt
    - name: checkout repo
      uses: actions/checkout@v4
    - name: run playbook
      run: ansible-playbook -i inventory playbook.yml --vault-password-file /tmp/vault_pass.txt
      working-directory: /home/adminuser/temp/ansible_quickstart
    - name: verwijder vault pass
      run: rm /tmp/vault_pass.txt

  testing:
    needs: configure
    runs-on: self-hosted
    steps:
    - name: checkout repo 
      uses: actions/checkout@v4
    - name: run playbook for testingVM
      run: ansible-playbook -i inventory testing.yml
      working-directory: /home/adminuser/temp/ansible_quickstart

  acceptance:
    needs: testing
    runs-on: self-hosted
    steps:
    - name: run playbook for acceptanceVM
      run: ansible-playbook -i inventory acceptance.yml
      working-directory: /home/adminuser/temp/ansible_quickstart

  production:
    needs: acceptance
    runs-on: self-hosted
    steps:
      - name: run playbook for productionVM
        run: ansible-playbook -i inventory production.yml
        working-directory: /home/adminuser/temp/ansible_quickstart

