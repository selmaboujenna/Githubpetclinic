on:
  push:
    branches:
      pets  
name: automate provisioning

jobs:
  build:
    runs-on: self-hosted
    steps:
    # - name: az login
    #   uses: azure/login@v1
    #   with:
    #     auth-type: IDENTITY
    #     client-id: ${{secrets.CLIENT_ID}}
    #     tenant-id: ${{secrets.TENANT_ID}}
    #     subscription-id: ${{secrets.SUBSCRIPTION_ID}}
    - name: insert repo on prov vm
      run: git clone -b pets https://github.com/selmaboujenna/Githubpetclinic.git
      working-directory: /home/adminuser
    - name: initialize terraform
      run: terraform init
      working-directory: /home/adminuser/Githubpetclinic/terraform
    - name: create VMs
      run: terraform apply --auto-approve
      working-directory: /home/adminuser/Githubpetclinic/terraform
  
  configure:
    needs: build
    runs-on: self-hosted
    steps:
    - name: maak een vault password file
      run: echo "${{secrets.VAULT_PASS}}" > /tmp/vault_pass.txt
    - name: checkout repo
      uses: actions/checkout@v4
    - name: run playbook
      run: ansible-playbook -i inventory playbook.yml --vault-password-file /tmp/vault_pass.txt
      working-directory: /home/adminuser/Githubpetclinic/ansible_quickstart
    - name: verwijder vault pass
      run: rm /tmp/vault_pass.txt

  testing:
    needs: configure
    runs-on: self-hosted
    steps:
    - name: checkout repo 
      uses: actions/checkout@v4
    - name: run playbook for testingVM
      run: ansible-playbook -i inventory testing.yml
      working-directory: /home/adminuser/Githubpetclinic/ansible_quickstart
    - name: upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-result
        path: /home/adminuser/Githubpetclinic/test-result.jtl
    

  acceptance:
    needs: testing
    runs-on: self-hosted
    steps:
    - name: run playbook for acceptanceVM
      run: ansible-playbook -i inventory acceptance.yml -v
      working-directory: /home/adminuser/Githubpetclinic/ansible_quickstart
    

  production:
    needs: acceptance
    runs-on: self-hosted
    steps:
      - name: run playbook for productionVM
        run: ansible-playbook -i inventory production.yml
        working-directory: /home/adminuser/Githubpetclinic/ansible_quickstart

  complete:
    needs: production
    runs-on: self-hosted
    steps:
      - name: delete testingVM
        run: terraform destroy --target azurerm_linux_virtual_machine.linux_vm[0] --auto-approve
        working-directory: /home/adminuser/Githubpetclinic/terraform
      - name: delete acceptanceVM
        run: terraform destroy --target azurerm_linux_virtual_machine.linux_vm[1] --auto-approve
        working-directory: /home/adminuser/Githubpetclinic/terraform
      - name: delete repo
        run: rm -r Githubpetclinic
        working-directory: /home/adminuser

